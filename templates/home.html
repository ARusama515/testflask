<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <h1>Welcome to the Flask Registration App</h1>
    <button onclick="startAudioStream()">Start</button>
    <button onclick="stopAudioStream()">Stop</button>

    <script>
        let socket;
        let audioContext;
        let mediaStream;
        let processor;

        async function startAudioStream() {
            // Open WebSocket connection
            socket = io.connect('http://localhost:5000');

            // Access the microphone
            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioContext = new AudioContext();
            const source = audioContext.createMediaStreamSource(mediaStream);
            processor = audioContext.createScriptProcessor(4096, 1, 1);

            source.connect(processor);
            processor.connect(audioContext.destination);

            // Send audio chunks to the server
            processor.onaudioprocess = (event) => {
                const audioData = event.inputBuffer.getChannelData(0);
                socket.emit('start_audio_stream', { audio_chunk: audioData });
            };

            // Handle agent response
            socket.on('agent_response', (data) => {
                const audioBlob = new Blob([data.response.audio], { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
            });
        }

        function stopAudioStream() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            if (processor) {
                processor.disconnect();
            }
            if (socket) {
                socket.disconnect();
            }
        }
    </script>
</body>
</html>
